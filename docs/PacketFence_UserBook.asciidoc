UserBook Guide
==============
:encoding: UTF-8
:lang: en
:doctype: book
:toc: left

////

    This file is part of the PacketFence project.

    See PacketFenceUserBook_Guide-docinfo.xml for authors, copyright
    and license information.

////

include::includes/global-attributes.asciidoc[]

About this Guide
----------------

This guide will walk you through the configuration of policies, from a simple example to something complex.

The instructions are based on version {release_version} of PacketFence.

The latest version of this guide is available online at http://www.packetfence.org/documentation/guides.html

Assumptions
~~~~~~~~~~~

 * You have a PacketFence installed and went through the configurator.
 * You are using a VLAN enforcement of WebAuth type of installation.
 * Your PacketFence is up and running, `Management` interface is reachable from your network equipement (wireless controller/switches).
 * There is no firewall in between your network equipements and PacketFence that could block 1700, 1812, 1813, 3799.


Introduction
~~~~~~~~~~~~

The UserBook is here to help you understand on how to configure your PacketFence for your need. This guide will explain to you how to configure simple setup and diffrent actions to complexify in the purpose to go to your final objective.


Wi-Fi configuration
~~~~~~~~~~~~~~~~~~~

To kick off we will configure a Public SSID (Open with MAC authentication and a portal login using PacketFence local users source, LDAP or SMS).

Open SSID
^^^^^^^^^

First of all you need to make sure the following are defined:

 * Wireless controller from which the request will come, in the section `Networks->Switches`.
 * Local source, sms source and LDAP source in the section `Users->Sources`.

We will start by configuring a Portal Profile related to this SSID.

Click on the section `Main->Portal Profiles`, now click `Add profile`.

In your Portal profile, define a Name and description. Add a filter using the condition SSID: `PF-Open`. Add your sources and save.

image::docs/images/portal-profile-creation.png[scaledwidth="100%",alt="Adding a new portal profiles"]
image::docs/images/portal-profile-filter-simple.png[scaledwidth="100%",alt="Adding a portal profile filter SSID"]
image::docs/images/portal-profile-sources.png[scaledwidth="100%",alt="Adding a portal profile sources"]

You have some options under the tab `Captive Portal` where you can add your logo company, and a redirection URL or the different languages in which the page will be available for instance. Have a look through those options.

image::docs/images/portal-profile-captive-portal.png[scaledwidth="100%",alt="Captive Portal tab under a portal profile"]

From now on, every one connecting from the SSID `PF-Open` will be landing on the portal define by this portal profile. They will be able to loggin with either SMS, local user or LDAP account.

Secure SSID
^^^^^^^^^^^

We will now add a Secure SSID (WPA2-Entreprise, that allow user to login through EAP-PEAP, User athentication, and autoregister authenticated users)

Configure your SSID on your wireless controller. On PacketFence if you don't have a portal profile with matching condition it will go through the default which if not modified has every availalble authentication sources, scans etc.

Here we will add a VLAN filter to allow users connecting in WPA2-Entreprise to be autoregister.

From the configuration go in `Main->Filter engies`, and we will edit the `VLAN filters`.

Create a filter as follow:

----
[wireless_eap]
filter = connection_type
operator = is
value = Wireless-802.11-EAP

[autoreg:wireless_eap]
scope = AutoRegister
role = default
----

BYOD and corporate devices
~~~~~~~~~~~~~~~~~~~~~~~~~~

We will now add the possibility to filter corportate and BYOD devices. One way to do that is to use Machine Authentication (Windows devices only) and for the other `corporate' devices  you need to use EAP-TLS.

Machine Authentication via LDAP
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

To begin create a new PacketFence role, under `Users->Roles` in the tab configuration, call it `corporate`.

To configure Machine Authentication, please configure a source LDAP with the setting *Username Attribube: servicePrincipalName* and make sure the *Base DN* is equal to where the `OU' where the computers you want to authenticate are. In the source rule, create one that will return de role `corporate`.

If you need additional information for configurating this source please refer to https://packetfence.org/doc/PacketFence_Administration_Guide.html#_authentication section `9.2.1: Example`.

Of course while configuring your SSID on your devices, under `Security->Advanced Settings` make sure to select `Computer authentication` in the tab `802.1X settings`. This will force the computer to authenticate via its LDAP machine account.

Others corporate devices
^^^^^^^^^^^^^^^^^^^^^^^^

Now that your Windows devices are able to be logged in with Machine Authentication you can class them as `corporate'. Let's say that you now need to add some `Linux computers' and `IPads' as `corporate' devices.

Thoses devices cannot be authenticate via Machine Authentication, so we will need to use EAP-TLS and provide thoses devices with certificate.

First of all make sure that your RADIUS certificate from the PacketFence server and the certificates that you will provide are delivered from the same CA, else your authentication will not work. To enable EAP-TLS you will need to reconfigure the new RADIUS server certificate in the file conf/radiusd/eap.conf.

While creating the RADIUS server certifcate make sure to have the Extended key usage: servAuth.

Under the section `tls-config tls-common`, search for `private_key_file', `certificate_file' and `ca_file'. Thoses should contain respectively the path of:

 * the private key for your PacketFence server,
 * the server certificate issued by your CA for your PacketFence server,
 * the public key of your CA.

If you have an `OCSP' capable PKI you can configure in the section `OSCP` in the eap.conf file.

Lastely you will need to restart RADIUS to ensure the use of the new configuration and certificates. Please do the following:

 * bin/pfcmd configureload hard
 * bin/pfcmd service radiusd restart

Make sure everything happens without errors.

Now that your RADIUS is ready to handle EAP-TLS, configure your SSID connection profile on the `corporate' device using this method. Generate a client certificate for your device and install it on.  

Please configure an EAPTLS source whcih can be found while adding a new sources under `Internal->`, simpely give it a name, a description and a catch-all rule. This will allow you to validate the authentication via EAP-TLS.

You can now create a new Portal Profile for EAP-TLS. Under the tab configuration, section `Main->Portal Profiles`, `Add profile` and select as a filter the Sub Connection Type as EAP-TLS, add your source EAP-TLS. Check the box "Automatically register devices". 

You know have a full flow working for your corporate devices.

Provisionning certificate
~~~~~~~~~~~~~~~~~~~~~~~~~

Let's now imagine that we want to automate the certificate process, for enrolling new devices where a certificate cannot be pushed via GPO. this is where the provisionning will act.


